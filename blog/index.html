<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.73">
<link rel="alternate" type="application/rss+xml" href="/safe_to_run/blog/rss.xml" title="Safe to run Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/safe_to_run/blog/atom.xml" title="Safe to run Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-158023887-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158023887-2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-158023887-2",{anonymize_ip:!0})</script><title data-react-helmet="true">Safe to run</title><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://safetorun.github.io/safe_to_run/safe_to_run/blog"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" property="og:image" content="https://safetorun.github.io/safe_to_run/safe_to_run/img/emulator.png"><meta data-react-helmet="true" name="twitter:image" content="https://safetorun.github.io/safe_to_run/safe_to_run/img/emulator.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Safe to run"><link data-react-helmet="true" rel="shortcut icon" href="/safe_to_run/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://safetorun.github.io/safe_to_run/safe_to_run/blog"><link data-react-helmet="true" rel="alternate" href="https://safetorun.github.io/safe_to_run/safe_to_run/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://safetorun.github.io/safe_to_run/safe_to_run/blog" hreflang="x-default"><link rel="stylesheet" href="/safe_to_run/assets/css/styles.006c1f60.css">
<link rel="preload" href="/safe_to_run/assets/js/styles.3abec5b9.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/runtime~main.0864b2d8.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/main.59006e46.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/1.b8232fab.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/2.357b4180.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/3.582dbeb6.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/a6aa9e1f.f799306a.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/f74cf27d.d5d33a6d.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/aa53fb36.95034faf.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/2e6d9176.7d97db7c.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/48062707.29553b3b.js" as="script">
<link rel="preload" href="/safe_to_run/assets/js/dc0df5a1.52134104.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/safe_to_run/"><img src="/safe_to_run/img/safetorun.jpg" alt="Safe to run" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/safe_to_run/img/safetorun.jpg" alt="Safe to run" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Safe to run</strong></a><a class="navbar__item navbar__link" href="/safe_to_run/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/safe_to_run/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/safetorun/safe_to_run/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/safe_to_run/"><img src="/safe_to_run/img/safetorun.jpg" alt="Safe to run" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/safe_to_run/img/safetorun.jpg" alt="Safe to run" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Safe to run</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/safe_to_run/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/safe_to_run/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/safetorun/safe_to_run/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/safe_to_run/blog/inline-functions">Secure against de/recompiling android apps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/safe_to_run/blog/emulator-detection">Emulator detection</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/safe_to_run/blog/safe-to-run">Secure android apps with Safe to run</a></li></ul></div></div><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/safe_to_run/blog/inline-functions">Secure against de/recompiling android apps</a></h2><div class="margin-vert--md"><time datetime="2021-06-24T00:00:00.000Z" class="blogPostDate_fNvV">June 24, 2021 Â· 6 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/dllewellyn" target="_blank" rel="noopener noreferrer">Daniel Llewellyn</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="using-kotlin-inline-functions-to-help-secure-against-derecompiling-android-apps"></a>Using kotlin Inline functions to help secure against de/recompiling android apps<a class="hash-link" href="#using-kotlin-inline-functions-to-help-secure-against-derecompiling-android-apps" title="Direct link to heading">#</a></h3><p>When trying to attack an android application, attackers often try to circumvent some of the protections you&#x27;ve
introduced into your app. For example, you might have a signature check added in order to prevent attackers from adding
malware into your app and republishing it:</p><p><a href="https://safetorun.github.io/safe_to_run/docs/signature" target="_blank" rel="noopener noreferrer">Safe to run - signature verification </a></p><p>They might also reverse your app to remove any root protection / detection you&#x27;ve added:</p><p><a href="https://safetorun.github.io/safe_to_run/docs/rootdetection" target="_blank" rel="noopener noreferrer">Safe to run - root detection</a></p><p>Or they might try to remove any other checks you have added, for example, checks to stop it running on an emulator:</p><p><a href="https://safetorun.github.io/safe_to_run/docs/emulatorcheck" target="_blank" rel="noopener noreferrer">Safe to run - emulator check</a></p><p>In order to make this harder, we can implement these checks using the inline keyword in kotlin. What makes it easy now?
To understand how inlining functions can help, we should first look at how easy it is without inlining. If we take an
application compiled with the &#x27;Safe to run&#x27; reporting checks <a href="https://github.com/safetorun/safe_to_run" target="_blank" rel="noopener noreferrer">Safe to run</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-standard-approach"></a>The standard approach<a class="hash-link" href="#the-standard-approach" title="Direct link to heading">#</a></h3><p>Let&#x27;s suppose we add this configuration</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SafeToRun.init(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    configure {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        osDetectionCheck(banAvdEmulator()).error()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To our Application or in MainActivity. Then we run one check at launch (in MainActivity onCreate())</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (SafeToRun.isSafeToRun().anyFailures()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    throw RuntimeException(&quot;Abc&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>And we also add a button to do a check, let&#x27;s say we have a button like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><div tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Button</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">android:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">@+id/runSensitiveAction</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">android:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">text</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Run sensitive action</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">app:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">layout_constraintTop_toTopOf</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">parent</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">app:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">layout_constraintStart_toStartOf</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">parent</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">app:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">layout_constraintEnd_toEndOf</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">parent</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">android:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">layout_width</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">match_parent</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">    </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">android:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">layout_height</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">wrap_content</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>And program it up like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">binding.runSensitiveAction.setOnClickListener {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (SafeToRun.isSafeToRun().anyFailures()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Toast.makeText(this, &quot;Not safe to run&quot;, Toast.LENGTH_LONG).show()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Toast.makeText(this, &quot;Performed sensitive action!!&quot;, Toast.LENGTH_LONG).show()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When you run the application on an emulator, it will throw an exception. So an attacker might try and take the emulator
detection out - let&#x27;s look at how this application decompiles. We might see something similar to this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public final void invoke(SafeToRunConfiguration $this$configure) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Intrinsics.checkNotNullParameter($this$configure,&quot;$receiver&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $this$configure.error(OSDetectionCheckKt.osDetectionCheck(this.this$0,C01051.INSTANCE));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If we can identify this single line and remove it, then we&#x27;ll be able to recompile having removed the root detection.
Let&#x27;s demonstrate. I&#x27;m using apk tool (full instructions on de/recompiling are a bit out of scope for this article but
I&#x27;ll add some of the steps for info):</p><p><code>apktool.sh d app-debug.apk</code> </p><p>This gives me the files as smali. If I look for the line of code doing the config I&#x27;ll see this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly smali"><div tabindex="0" class="prism-code language-smali codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">check-cast v1, Lkotlin/jvm/functions/Function1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-static {v0, v1}, Lio/github/dllewellyn/safetorun/features/rootdetection/RootDetectionConfigKt;-&gt;rootDetection(Landroid/content/Context;Lkotlin/jvm/functions/Function1;)Lio/github/dllewellyn/safetorun/checks/SafeToRunCheck;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.line 94</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-virtual {p1, v0}, Lio/github/dllewellyn/safetorun/SafeToRunConfiguration;-&gt;error(Lio/github/dllewellyn/safetorun/checks/SafeToRunCheck;)V</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>if I remove the final line, it will not run .error() and basically remove the check. So let&#x27;s do that and recompile:</p><p><code>apktool.sh b -f -d app-debug</code></p><p>Zipalign the result </p><p><code>./zipalign -v 4 app-debug.apk app-debug-aligned.apk</code> </p><p>Then sign (password is android)</p><p><code>apksigner sign --ks ~/.android/debug.keystore output.apk</code> </p><p>Then install <code>adb install app-debug-aligned.apk</code> and you&#x27;ll see it runs. </p><p>Click the &#x27;sensitive button&#x27; and the action is performed. </p><p>The issue This was a fairly straight forward set of steps to remove our check, because you&#x27;ve removed the
configuration in a single place, every place that safe to run is called has now been removed. In order to make all of this harder, we&#x27;d ideally want to make it so that if we add two
checks, it takes double the effort to remove them (and three checks triple.. etc etc). </p><p>Inlining In SafeToRun 1.0.3 we have introduced a new function which uses inline functions to make de/recompilation harder.
As a reminder, in usual compilation when you call a function, the compiled code looks similar to your un-compiled code -
in the sense that it has a reference to that function, and jumps to where that function is in the binary. When we Inline a
function, the whole function you&#x27;re calling is copied inside the calling function at compile time. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="inlined-function"></a>Inlined function<a class="hash-link" href="#inlined-function" title="Direct link to heading">#</a></h3><p>Let&#x27;s add this function to MainActivity:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">private inline fun canIRun(actionOnFailure: () -&gt; Unit) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (safeToRun(buildSafeToRunCheckList {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            add {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                banAvdEmulatorCheck()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        actionOnFailure()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>One thing to note is that the syntax for the inlined versioning of Safe to Run is still in active development at the
time of writing, be sure to check the documentation for the most up-to-date syntax If also add this block of code into
the button click, and also into onCreate for MainActivity:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">canIRun { throw RuntimeException(&quot;Error with safe to run&quot;) }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We&#x27;ll repeat the compilation and recompilation stage. After a bit of digging, I found something that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly smali"><div tabindex="0" class="prism-code language-smali codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">.method public bridge synthetic invoke()Ljava/lang/Object;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.locals 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-virtual {p0}, Lcom/andro/secure/MainActivity$canIRun$$inlined$safeToRun$2;-&gt;invoke()Z</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-static {v0}, Ljava/lang/Boolean;-&gt;valueOf(Z)Ljava/lang/Boolean;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">return-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.end method</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>and I replaced it with this code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly smali"><div tabindex="0" class="prism-code language-smali codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">.method public bridge synthetic invoke()Ljava/lang/Object;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.locals 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-virtual {p0}, Lcom/andro/secure/MainActivity$canIRun$$inlined$safeToRun$2;-&gt;invoke()Z</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-static {v0}, Ljava/lang/Boolean;-&gt;valueOf(Z)Ljava/lang/Boolean;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const v0, 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">invoke-static {v0}, Ljava/lang/Boolean;-&gt;valueOf(Z)Ljava/lang/Boolean;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">move-result-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">return-object v0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.end method</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>All this does is returns &#x27;false&#x27; (i.e. the check returns false in the inlined version we return a boolean indicating
true if a check failed rather than a SafeToRunReport)</p><p>If we recompile using the same steps as before, you&#x27;ll find that the app runs. However, clicking the button will still
cause a RuntimeException. The reason is that the entire functions call chain is duplicated inside the button click. This
adds some size to the binary but now an attacker would need to find the function in every place where you have called &#x27;
canIRun&#x27; making the job much harder. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusions"></a>Conclusions<a class="hash-link" href="#conclusions" title="Direct link to heading">#</a></h3><p>In this article we&#x27;ve demonstrated that by using inline functions (for
the entire chain) and no classes etc, it is exponentially more difficult to remove device safety checks the more checks
you add. </p><p>If you were to add a single check at runtime, it would not be any more difficult - however if you litter your
code with Safe to run checks, you will find it harder to decompile and remove those checks. As ever, it&#x27;s
impossible to have a foolproof way of preventing re/decompiling due to the nature of the problem - but inlining functions
in this way can help make it harder for an attacker</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/security">security</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/android">android</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/safetorun">safetorun</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/inline">inline</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/decompilation">decompilation</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/recompilation">recompilation</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/kotlin">kotlin</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/inline">inline</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/safe_to_run/blog/emulator-detection">Emulator detection</a></h2><div class="margin-vert--md"><time datetime="2021-06-23T00:00:00.000Z" class="blogPostDate_fNvV">June 23, 2021 Â· 3 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/dllewellyn" target="_blank" rel="noopener noreferrer">Daniel Llewellyn</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="emulator-detection-with-safe-to-run"></a>Emulator detection with safe to run<a class="hash-link" href="#emulator-detection-with-safe-to-run" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what"></a>What?<a class="hash-link" href="#what" title="Direct link to heading">#</a></h3><p>Emulator detection is the ability to tell when your application is running on an emulator rather than a real device, but why would you want to do this?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="why"></a>Why?<a class="hash-link" href="#why" title="Direct link to heading">#</a></h3><p>Reverse engineers, pentesters and hackers tend to like running your app on an emulator can be make it far easier reveal what your application is doing. A somewhat convoluted example is looking at an applicationâ€™s files in their private directory. For example:</p><p>In that case, we can see that by preventing our app running on an emulated device, it can make it more difficult for a penetration tester to observe our application.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how"></a>How?<a class="hash-link" href="#how" title="Direct link to heading">#</a></h3><p>Weâ€™re going to use the library Safe to run for both the detection and to help identify the emulator.</p><p>Core Safe to run (android library) The purpose of this configuration is to provide a simple and extensible framework</p><p>Safe to run has a utility to show device information:</p><p><code>Log.v(&quot;Device information&quot;, deviceInformation().toString())</code></p><p>If we run this into application on the Android emulator, it looks like this:</p><p><code>DeviceInformation(osCheck=OsCheck(osVersion=30, manufacturer=Google, model=sdk_gphone_x86, board=goldfish_x86, bootloader=unknown, cpuAbi=[x86, armeabi-v7a, armeabi], host=abfarm-us-west1-c-0089, hardware=ranchu, device=generic_x86_arm), installOrigin=InstallOrigin(installOriginPackageName=), signatureVerification=SignatureInformation(signature=))</code></p><p>And just to double check with another emulator we get this result</p><p><code>DeviceInformation(osCheck=OsCheck(osVersion=30, manufacturer=Google, model=sdk_gphone_x86_arm, board=goldfish_x86, bootloader=unknown, cpuAbi=[x86, armeabi-v7a, armeabi], host=abfarm-us-west1-c-0007, hardware=ranchu, device=generic_x86_arm), installOrigin=InstallOrigin(installOriginPackageName=), signatureVerification=SignatureInformation(signature=))</code></p><p>Thereâ€™s da few things we could pick out here, but in particular we can probably start to build up this as an emulator check. Weâ€™ll write up a configuration for safe to run:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SafeToRun.init(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    configure {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        osDetectionCheck(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            conditionalBuilder {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                with(bannedBootloader(&quot;unknown&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                and(bannedDevice(&quot;generic_x86_arm&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                and(bannedBoard(&quot;goldfish_x86&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ).error()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Log.v(&quot;SafeToRunResult&quot;, SafeToRun.isSafeToRun().toString())</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This check will result in the following failure</p><p><code>MultipleReports(reports=[MultipleReports(reports=[SafeToRunReportFailure(failureReason=os-config-failure, failureMessage=Banned bootloader unknown == unknown)])])</code>
Genymotion
Another popular emulator is GenyMotion. If we go to the cloud GenyMotion, we can test our experiments on devices there. After connecting and installing out devices, we can have a look again at the deviceInformation() output
Genymotion Cloud SaaS
Edit description
cloud.geny.io</p><p>`DeviceInformation(osCheck=OsCheck(osVersion=28, manufacturer=Genymotion, model=Huawei P30 Pro, board=unknown, bootloader=unknown, cpuAbi=[x86], host=68d6ec695a7c, hardware=vbox86, device=vbox86p), installOrigin=InstallOrigin(installOriginPackageName=), signatureVerification=SignatureInformation(signature=))</p><p>Easy peasy, we can create a new rule for Genymotion:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">osDetectionCheck(conditionalBuilder {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    with(bannedBoard(&quot;unknown&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    and(notManufacturer(&quot;Genymotion&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    and(bannedBootloader(&quot;unknown&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}).error()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Bluestacks
Another popular emulator is bluestacks. After installing and running it, we get this:</p><p><code>DeviceInformation(osCheck=OsCheck(osVersion=25, manufacturer=samsung, model=SM-G955F, board=universal8895, bootloader=unknown, cpuAbi=[x86_64, x86, arm64-v8a, armeabi-v7a, armeabi], host=Build2, hardware=samsungexynos8895, device=dream2lte), installOrigin=InstallOrigin(installOriginPackageName=), signatureVerification=SignatureInformation(signature=))</code></p><p>This is actually a tricky one for now because the rest of the description is very similar to a real device that we wouldnâ€™t want to block. We can safely use this rule for bluestacks though:</p><p><code>with(bannedBootloader(OsCheckConstants.UNKNOWN))</code></p><p>Making it easier
From 1.0.2 onwards, Safe to run provides two utility functions for these two emulators (more coming soon)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><div tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SafeToRun.init {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    osDetectionCheck(banAvdEmulator()).error()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    osDetectionCheck(banGenymotionEmulator()).error()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    osDetectionCheck(banBluestacksEmulator()).error()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>Hopefully that gives us an idea of how we can perform emulator detection on Android, Safe to run provides a number of ways of checking for device information so you can tweak parameters for emulator detection â€” naturally there are a plenty of emulators weâ€™e not discussed here that you might want to write a check for.
Enjoy</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/security">security</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/android">android</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/safetorun">safetorun</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/emulator-detection">emulator detection</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/kotlin">kotlin</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/safe_to_run/blog/safe-to-run">Secure android apps with Safe to run</a></h2><div class="margin-vert--md"><time datetime="2021-06-22T00:00:00.000Z" class="blogPostDate_fNvV">June 22, 2021 Â· 2 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/dllewellyn" target="_blank" rel="noopener noreferrer">Daniel Llewellyn</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>No library or app can guarantee not running on a rooted phone because of the nature of rooted phones, and any tamper detection could be removed or changed in reality â€” this app should work with most attackers, and make it hard enough to make it not worth it for many others.
Background</p></div></div><p>Safe to run is intended to provide a layer of security for Android applications from rooted phones, reverse engineering, binary modification, malicious apps and some security vulnerabilities.</p><p>In principle, you set the parameters for a safe device, (one where the debugger is not attached, one with a minimum OS version, one not rooted etc) and ask â€˜is it safe to runâ€™.</p><p>You know best the time and place to ask the question-maybe you do it on app launch and throw an exception, maybe you ask when some tries to make a payment to someone else and reject the payment or maybe you do it before retrieving some data from the backend.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="checks"></a>Checks<a class="hash-link" href="#checks" title="Direct link to heading">#</a></h3><p>We have the following checks that are configurable in safe to run</p><ul><li>Signature checks â€” check the signature of the binary (set multiple for multiple certs)</li><li>Debug check â€” check if the debugger is attached or if the app is debuggable</li><li>Device check â€” blacklist a combination of OS version and device manufacturer</li><li>Root check â€” check for signs which point to the device being rooted</li><li>Other packages check â€” check for the presence of other packages, e.g. You might not want to run if you know a specific app is running because itâ€™s known malware that might attack your app</li><li>Install origin check â€” check for the installing package of your app, this can help to make reverse engineering harder</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sample-usage"></a>Sample usage<a class="hash-link" href="#sample-usage" title="Direct link to heading">#</a></h3><p>Every time you want to run a check execute:</p><p><code>SafeToRun.safeToRun()</code></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/security">security</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/android">android</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/safetorun">safetorun</a><a class="margin-horiz--sm" href="/safe_to_run/blog/tags/kotlin">kotlin</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Safe to run. Built with Docusaurus.</div></div></div></footer></div>
<script src="/safe_to_run/assets/js/styles.3abec5b9.js"></script>
<script src="/safe_to_run/assets/js/runtime~main.0864b2d8.js"></script>
<script src="/safe_to_run/assets/js/main.59006e46.js"></script>
<script src="/safe_to_run/assets/js/1.b8232fab.js"></script>
<script src="/safe_to_run/assets/js/2.357b4180.js"></script>
<script src="/safe_to_run/assets/js/3.582dbeb6.js"></script>
<script src="/safe_to_run/assets/js/a6aa9e1f.f799306a.js"></script>
<script src="/safe_to_run/assets/js/f74cf27d.d5d33a6d.js"></script>
<script src="/safe_to_run/assets/js/aa53fb36.95034faf.js"></script>
<script src="/safe_to_run/assets/js/2e6d9176.7d97db7c.js"></script>
<script src="/safe_to_run/assets/js/48062707.29553b3b.js"></script>
<script src="/safe_to_run/assets/js/dc0df5a1.52134104.js"></script>
</body>
</html>